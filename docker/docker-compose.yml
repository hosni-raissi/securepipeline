services:
  # Vulnerable Flask Application
  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=development
      - PYTHONUNBUFFERED=1
    volumes:
      - ../app:/app
    networks:
      - securepipeline

  # SonarQube for SAST
  sonarqube:
    image: sonarqube:10-community
    ports:
      - "9000:9000"
    environment:
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
    networks:
      - securepipeline

  # PostgreSQL for SonarQube
  sonarqube-db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar
      - POSTGRES_DB=sonarqube
    volumes:
      - postgresql_data:/var/lib/postgresql/data
    networks:
      - securepipeline

    # OWASP ZAP for DAST
  zap:
    image: zaproxy/zap-stable:latest
    ports:
      - "8080:8080"
      - "8090:8090"
    command: zap-webswing.sh
    networks:
      - securepipeline

  # OPA Server for Policy Enforcement
  opa:
    image: openpolicyagent/opa:latest
    ports:
      - "8181:8181"
    command:
      - "run"
      - "--server"
      - "--addr=0.0.0.0:8181"
      - "/policies"
    volumes:
      - ../security/opa/policies:/policies
    networks:
      - securepipeline

networks:
  securepipeline:
    driver: bridge

volumes:
  sonarqube_data:
  sonarqube_extensions:
  sonarqube_logs:
  postgresql_data:
